<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">
<head>
<meta charset="UTF-8">
<style>
/* .row {
	border: 1px solid white;
} */
#container {
	justify-content: center;
}

table {
	text-align: center;
}

.form-check {
	justify-content: center;
}
</style>
</head>
<body>
	<div layout:fragment="Main" id="container">

		<!-- <form id="updateForm">
			<select class="form-select mb-6" aria-label="Default select example"
				id="option">
				<option selected>조회할 기간 선택(최근 3개월)</option>
			</select>

		<div>
			<div class="bg-light rounded h-100 p-4">
				<h6 class="mb-4" style="text-align: center;">납부내역</h6>
				<div class="container text-center">
					<div class="row">
						<div class="col-12 col-sm-6">월세</div>
						<div class="col-12 col-sm-6">관리비</div>
						Ajax에서 받아온 내용을 append 활용해서 데이터 출력하는 부분
						<div class="col-12 col-sm-3 delete" id="rentMonth"></div>
						<div class="col-12 col-sm-3 delete" id="Rentpay"></div>
						<div class="col-12 col-sm-3 delete" id="gwanlibiMonth"></div>
						<div class="col-12 col-sm-3 delete" id="Gwanlibi"></div>
					</div>
				</div>
			</div>
		</div> -->

		<form id="updateForm">
			<div>
				<table class="table table-bordered">
					<thead>
						<tr>
							<th colspan="2">납부 내역 &nbsp; &nbsp;<select
								aria-label="Default select example" id="option">
									<option selected>조회기간(최근 3개월)</option>
							</select></th>
						</tr>
						<tr>
							<th>월세</th>
							<th>관리비</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<!-- 월세 출력 -->
							<td>
								<table>
									<tbody>
										<tr>
											<td class="delete" id="rentMonth"></td>
											<td>&nbsp; &nbsp;</td>
											<td class="delete" id="Rentpay"></td>
										</tr>
									</tbody>
								</table>
							</td>
							<td>
								<table>
									<tbody>
										<tr>
											<td class="delete" id="gwanlibiMonth"></td>
											<td>&nbsp; &nbsp;</td>
											<td class="delete" id="Gwanlibi"></td>
										</tr>
									</tbody>
								</table>
							</td>
				</table>


				<table class="table table-bordered">
					<thead>
						<tr>
							<th colspan="2">납부 예정</th>
						</tr>
						<tr>
							<th>월세</th>
							<th>관리비</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								<!-- 월세 출력 -->
								<table>
									<tbody id="payTotal">
										<th:block th:each="payInF : ${payInfo}">
											<tr>
												<td><div class="form-check">
														<input class="form-check-input check" type="checkbox"
															th:value="${payInF.mRentHistoryNo}" id="checkbox"
															name="mRentHistoryNo"><label
															class="form-check-label" for="flexCheckDefault"></label>
													</div></td>
												<td>[[${#strings.substring(payInF.realPaymentDate, 0,
													11)}]]</td>
												<td>[[${#numbers.formatInteger(payInF.realPaymentMoney, 3,
													'COMMA')}]]</td>
												<td th:if="${payInF.paymentState == -1}"><font color="red">
														연체</font></td>
												<td th:if="${payInF.paymentState != -1}"><font
													color="green"> 예정</font></td>
											</tr>
										</th:block>
									</tbody>
								</table>
							</td>

							<!-- 관리비 출력 -->
							<td>
								<table class="table table-bordered">
									<tbody id="paytotal">
										<th:block th:each="payInF : ${payInfo}">
											<tr>
												<td><div class="form-check">
														<input class="form-check-input check" type="checkbox"
															th:value="${payInF.gaguPaymentHistoryNo}" id="checkbox"
															name="gaguPaymentHistoryNo"><label
															class="form-check-label" for="flexCheckDefault"></label>
													</div></td>
												<td>[[${#strings.substring(payInF.paymentMonth, 0,
													11)}]]</td>
												<td>[[${#numbers.formatInteger(payInF.gaguGwanlibi, 3,
													'COMMA')}]]</td>
												<td th:if="${payInF.paymentYN == -1}"><font color="red">
														연체</font></td>
												<td th:if="${payInF.paymentYN != -1}"><font
													color="green"> 예정</font></td>
											</tr>
										</th:block>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
				<table>
					<tr>
						<th>
							<button type="button" id="payBtn" class="btn btn-outline-primary">결제하기</button>
						</th>
						<th>결제 금액 :</th>
						<td id="total"></td>
					</tr>
				</table>
			</div>
		</form>

		<script type="text/javascript"
			src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>

		<script>
			let date = new Date();
			let nowMonth = dateToM(date);
			let startMonth = nowMonth - 4;
			let year = dateToYear(date)
			let yearM;
			for (let i = startMonth; i < nowMonth - 1; i++) {
				let optionDate = dateToM(new Date(year, i, 1));
				yearM = dateToYM(new Date(year, i, 1))
				//console.log(dateToM(new Date(year, i, 1)));
				$('#option').append(
						`<option value="${yearM}">` + optionDate
								+ '월 </option>');
			}

			//납부조회 날짜를 클릭했을 때 해당 월의 납부 조회기록 출력을 위해 Ajax 사용

			$('#option').on('change', selectMonth)

			function selectMonth(event) {
				let payDate = event.target.value;
				
				console.log(payDate);
				
				$.ajax(ctxPath + "/paymentAjax", {
					type : "GET",
					//contentType : "application/json",
					data : {
						 payDate: payDate
					},
				}).done(
						function(payDate) {
							console.log("ddddddddd : ", payDate);
							
							//현재 다른 결제월의 test데이터는 없는데, 다른 결제월을 선택해도 기존의 결제일에 출력된 데이터가 계속 남아있어서 작성함.
								$('.delete').html('');
								
								for(let i = 0; i < payDate.length; i++) {
									if(i == 0){
									let paymentMonth = payDate[i].paymentMonth; //2024-07-07 00:00:00()
									let yearG = paymentMonth.substring(0, 4); //2024
									let monthG = paymentMonth.substring(5, 7); //07
									let dayG = paymentMonth.substring(8, 10); //07
									let payG = `${yearG}/${monthG}/${dayG}`; //2024/07/07
											
									$('#gwanlibiMonth').html(payG);
									$('#Gwanlibi').html(
											payDate[i].gaguGwanlibi.toString().replace(
													/\B(?=(\d{3})+(?!\d))/g, ","));
									} else {
											
									let realPaymentDate = payDate[i].realPaymentDate;
									let yearM = realPaymentDate.substring(0, 4); //2024
									let monthM = realPaymentDate.substring(5, 7); //07
									let dayM = realPaymentDate.substring(8, 10); //07
									let payM = `${yearM}/${monthM}/${dayM}`;	
									
									$('#rentMonth').html(payM);
									$('#Rentpay').html(
											payDate[i].realPaymentMoney.toString().replace(
													/\B(?=(\d{3})+(?!\d))/g, ","));
									}
							}
						}
					)
				}			
			
			
//			<<<<<<<<< 관리비 >>>>>>>>>>>

			//체크한 달의 관리비 값 합산
						
			$(".check").click(
			
					function(e) {
						//console.log($(e.target).closest('tr').children().eq(2).text());
						let payMoney = $('#paytotal').find('tr');
						let total = 0;
						for (let i = 0; i < payMoney.length; i++) {
							//find(배열 내에서 특정 요소(id가 checkbox)를 찾아냄), prop() : 체크여부에 따라 true, false 반환
							if (payMoney.eq(i).find('#checkbox').prop("checked")) {
								total += Number(payMoney.eq(i).children().eq(2).text().replace(",",""));
							}
						}
						$('#total').text(total);
						console.log(payMoney)
					})
			
			//결제 여부 ajax로 갱신
			$("#payBtn").on("click", updateAjax);
			
		 	//console.log(updateInfo.getAll());
			
			function updateAjax(){
			 	let listFormObj = [];
			 	let formObjArr = $(updateForm).serializeArray();
			 	formObjArr.forEach(obj => {
			 		let paymentResult = {}; 
			 		paymentResult[obj.name] = obj.value;
			 		listFormObj.push(paymentResult);
		 		});
			 	console.log(JSON.stringify(listFormObj));
				//return;
				$.ajax(ctxPath + "/updateAjax", {
					type : "post",
					contentType : "application/json",
					data : JSON.stringify(listFormObj),
				})
				.done((result) => {
					alert("납부 성공");
					location.href = ctxPath + "/paymentInfo";
				})
				.fail((err) => alert("결제 오류"));
			} 
			
			
			function getList(){
				let checks =$('.check:checked');
				let checkList = [];
				for(chk of checks){
					let gaguPaymentHistoryNo = chk.value;
					checkList.push({gaguPaymentHistoryNo});
				}
				return checkList;
			} 
			
			
//			<<<<<<<<< 월세 >>>>>>>>>>>						
			
			
			
			
			
			
			
			
			
			
			
			

			/* //결제 api
			 $('#payBtn').on('click', payImp)
			
			 function payImp() {
			 let imp = window.IMP;
			 imp.init('imp04648344'); //가맹점 식별코드
			 IMP.request_pay({
			 pg : 'html5_inicis',
			 pay_method : 'vbank',
			 merchant_uid: this.email + '_' + new Date().getTime(), // 주문번호(메일+날짜+시간)
			 name : '결제테스트',
			 amount : this.price,
			 buyer_email : this.email,
			 buyer_name : this.email,
			 buyer_tel : this.phone,
			 //buyer_addr : '주소',
			 //buyer_postcode : '우편번호'
			 }, function(rsp) { 
			 });

			 }  */
			
			
		</script>
	</div>
</body>
</html>
