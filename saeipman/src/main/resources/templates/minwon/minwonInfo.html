<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default_layout}"
  layout:fragment="Main"
>
  <head>
    <meta charset="UTF-8" />
    <title>Insert title here</title>
  </head>
  <style>
    .ply {
      padding-left: 50px;
    }
  </style>
  <body>
    <div>
      <input type="hidden" id="postNo" th:value="${minwon.postNo}" />
    </div>
    <div>
      <table>
        <tr>
          <th>제목</th>
          <td>[[${minwon.title}]]</td>
          <th>작성자</th>
          <td>[[${minwon.roomNo}]]</td>
        </tr>
        <tr>
          <th>카테고리</th>
          <td>[[${minwon.categoryType}]]</td>
        </tr>
        <tr>
          <th>방문날짜</th>
          <td>[[${minwon.visitsDate}]]</td>
        </tr>
        <tr>
          <th>내용</th>
          <td id="textarea">[[${minwon.content}]]</td>
        </tr>
        <tr>
          <th>첨부</th>
          <td>
            <img
              th:each=" img : ${minwon.chumbuImages}"
              th:src="@{/images/{f}(f=${img})}"
            />
          </td>
        </tr>
      </table>
    </div>
    <div>
      <button
        type="button"
        th:onClick="|location.href = '@{/minwonUpdate(postNo=${minwon.postNo})}'|"
      >
        수정
      </button>
      <button
        type="button"
        th:onClick="|location.href = '@{/minwonList(pageNum=${cri.pageNum}, type=${param.type}, keyword=${param.keyword})}'|"
      >
        목록
      </button>
      <button
        type="button"
        th:onClick="|location.href = '@{/minwonDelete(postNo=${minwon.postNo})}'|"
      >
        삭제
      </button>
    </div>
    <div>
      <!-- 접수 버튼 -->
      <form th:action="@{/updateMinwonState}" method="post">
        <input type="hidden" name="postNo" th:value="${minwon.postNo}" />
        <input type="hidden" name="state" th:value="1" />
        <!-- 접수중은 숫자 1로 전송 -->
        <button type="submit">접수</button>
      </form>

      <!-- 완료 버튼 -->
      <form th:action="@{/updateMinwonState}" method="post">
        <input type="hidden" name="postNo" th:value="${minwon.postNo}" />
        <input type="hidden" name="state" th:value="2" />
        <!-- 처리 완료는 숫자 2로 전송 -->
        <button type="submit">완료</button>
      </form>
    </div>

    <div>
      <section id="comments-section" th:style="'margin-top: 20px;'">
        <div id="comments-container">
          <!-- 댓글 목록이 여기에 동적으로 추가될 것입니다. -->
          <div class="ms-3" id="cmtContainer"></div>
        </div>
        <!-- 댓글 작성 폼 -->
        <form id="comment-form">
          <div class="form-group">
            <label for="comment">댓글 추가:</label>
            <textarea class="form-control" id="comment" rows="3"></textarea>
          </div>
          <button type="button" class="btn btn-primary" id="create-comment-btn">
            댓글 작성
          </button>
        </form>
      </section>

      <!-- 대댓글 작성 폼 -->
      <!-- 	<form id="comment-form">
			<div class="form-group">
				<label for="reply">대댓글 추가:</label>
				<textarea class="form-control" id="reply" rows="3"></textarea>
			</div>
			<button type="button" class="btn btn-primary" id="reply-comment-btn">댓글
				작성</button>
		</form> -->
    </div>

    <script>
      var str = $("#textarea").html();
      let postNo = $("#postNo").val();

      str = str.replace(/(?:\r\n|\r|\n)/g, "<br/>");

      $("#textarea").html(str);
      loadComment();

      //댓글 목록 가져오기
      function loadComment() {
        $.ajax({
          url: ctxPath + "/comments/" + postNo,
          method: "GET",
          success: function (response) {
            let commentsContainer = $("#comments-container .ms-3");
            commentsContainer.empty(); // 기존 댓글 삭제

            // 댓글 리스트가 있는 경우
            if (response.comments.length) {
              // response.comments가 있으면 그 길이 알려줌 없으면 undefined
              response.comments.forEach(function (comment) {
                let formattedDate = new Date(comment.regDate);
                let dateString = `${formattedDate.getFullYear()}-${(
                  "0" +
                  (formattedDate.getMonth() + 1)
                ).slice(-2)}-${("0" + formattedDate.getDate()).slice(-2)} ${(
                  "0" + formattedDate.getHours()
                ).slice(-2)}:${("0" + formattedDate.getMinutes()).slice(-2)}`;

                let deleteButton = `<button class="delete-comment-btn" data-id="${comment.minwonCmtNo}">삭제</button>`;

                let ply = comment.cmtRep == "1" ? "class='ply'" : "";
                let onkey = comment.cmtRep == "0" ? "id='onkey'" : "";
                if (comment.cmtRep == "0") {
                  let groupDiv = `
                    	   <div id='group${comment.cmtGroup}' class="group" data-group="${comment.cmtGroup}">
	                    	   <div ${ply} ${onkey}>
		                           <div class="fw-bold">${comment.writer}</div> <!-- 작성자 -->
		                           <div>${comment.content}</div> <!-- 댓글 내용 -->
		                           <div>${dateString}</div> <!-- 작성일 -->
		                           <input type="hidden" value=${comment.cmtGroup}>
		                           ${deleteButton}
	                       	   </div>
                    	   </div>`;
                  commentsContainer.append(groupDiv);
                } else {
                  let $groupDiv = $(`#group${comment.cmtGroup}`);
                  let commentElement = `
	                           <div ${ply}>
	                               <div class="fw-bold">${comment.writer}</div> <!-- 작성자 -->
	                               <div>${comment.content}</div> <!-- 댓글 내용 -->
	                               <div>${dateString}</div> <!-- 작성일 -->
	                               <input type="hidden" value=${comment.cmtGroup}>
	                           </div>
	                       `;
                  $groupDiv.append(commentElement);
                }

                // 댓글을 테이블에 추가
              }); // 댓글출력 반복문 끝
              let $groupDivs = $(".group");
              $groupDivs.each((idx, div) => {
                let replyForm = `
                			<form id="cmtfrm${div.dataset.group}" style="display:none;">
                				<input type="hidden" name="cmtGroup" value="${div.dataset.group}">
	                			<div class="form-group">
	                				<label for="reply">대댓글 추가:</label>
	                				<textarea class="form-control" id="reply" rows="3"></textarea>
	                			</div>
	                			<button type="button" class="btn btn-primary" id="reply-comment-btn">댓글
	                				작성</button>
                			</form>
                		`;
                $(div).append(replyForm);
              });
            } else {
              console.log("댓글이 없습니다.");
            }
          },
          error: function (err) {
            console.log("댓글 불러오기 실패", err);
          },
        });
      }

      // 댓글등록 버튼 클릭 이벤트
      let cmtBtn = document.getElementById("create-comment-btn");
      cmtBtn.addEventListener("click", function (e) {
        let content = $("#comment").val();
        let writer = "user01";
        let postNo = $("#postNo").val();

        let data = { content, writer, postNo };
        $.ajax({
          url: ctxPath + "/comments/" + postNo,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            console.log(response, "성공");
            loadComment();
          },
          error: function (err) {
            alert("댓글 등록 실패");
          },
        });
      });

      // 대댓글 FORM 보이기 그룹이벤트
      $("div#cmtContainer").on("click", "div.group", (e) => {
       // console.log(e.currentTarget, "target");
        let target = $(e.currentTarget);
        console.log(target.children().last());
        
        target.children().last().show()
      
    
        
      });

      //대댓글 등록 버튼
      let replyBtn = document.getElementById("reply-comment-btn");
      replyBtn.addEventListener("click", function (e) {
        let content = $("#reply").val();
        let writer = "user01";
        let postNo = $("#postNo").val();
        let data = { content, writer, postNo };
        $.ajax({
          url: ctxPath + "/replycomment/" + postNo,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            console.log(response, "성공");
            loadComment();
          },
          error: function (err) {
            alert("댓글 등록 실패");
          },
        });
      });

      //댓글 삭제
    </script>
  </body>
</html>
