<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Main">
<head>
<meta charset="UTF-8" />
<title>Insert title here</title>
</head>
<style>
/* 댓글 섹션 스타일 */
#comments-section {
	margin-top: 30px;
	padding: 10px;
	background-color: #f9f9f9;
	border: 1px solid #ddd;
}

.form-group {
	margin-bottom: 10px;
}

/* 댓글 영역 */
.ply {
	padding-left: 50px;
}

.fw-bold {
	font-weight: bold;
}

#textarea {
	white-space: pre-line;
}

.comment-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 10px;
}

.comment-content {
	margin-bottom: 10px;
	line-height: 1.5;
}

.comment-footer {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-size: 0.9em;
	color: #666;
}

.delete-comment-btn {
	background-color: transparent;
	border-width: thin;
}

/* 댓글 작성 폼 스타일 */
textarea {
	width: 100%;
	resize: vertical;
}

.group {
	margin-bottom: 15px;
}

/* 버튼 중앙 정렬 */
.button-container {
	display: flex;
	justify-content: center;
	margin-top: 20px;
}
</style>
<body>
	<div>
		<input type="hidden" id="postNo" th:value="${minwon.postNo}" /> <input
			type="hidden" id="loginId" th:value="${loginId}">
	</div>
	<div>
		<table class="table">
			<tr class="col-md-12">
				<th style="width: 5%">제목</th>
				<td style="width: 30%">[[${minwon.title}]]</td>
				<th>작성자</th>
				<td>[[${minwon.roomNo}]]</td>
			</tr>
			<tr>
				<th>카테고리</th>
				<td>[[${minwon.categoryType}]]</td>
			</tr>
			<tr>
				<th>방문날짜</th>
				<td
					th:text="${#temporals.format(minwon.visitsDate2, 'yyyy-MM-dd HH:mm')}"></td>

				<th th:if="${minwon.visitsDate2 != null}">or</th>
				<td
					th:text="${#temporals.format(minwon.visitsDate2, 'yyyy-MM-dd HH:mm')}"></td>
			</tr>
			<tr>
				<th>내용</th>
				<td id="textarea">[[${minwon.content}]]</td>
			</tr>
			<tr>
				<th style="width: 10%">첨부파일</th>
				<td><img style="width: 75%" th:each=" img : ${minwon.fileName}"
					th:src="@{/images/민원/{f}(f=${img})}" /></td>
			</tr>
		</table>
	</div>
	<div class="button-container" th:if="${cri.auth == 2}">
		<button type="button"
			th:onClick="|location.href = '@{/minwonUpdate(postNo=${minwon.postNo})}'|"
			class="btn btn-outline-warning m-2">수정</button>
		<button type="button"
			th:onClick="|location.href = '@{/minwonList(pageNum=${cri.pageNum}, type=${param.type}, keyword=${param.keyword})}'|"
			class="btn btn-outline-success m-2">목록</button>
		<button type="button"
			th:onClick="|location.href = '@{/minwonDelete(postNo=${minwon.postNo})}'|"
			class="btn btn-outline-danger m-2">삭제</button>
	</div>

	<div class="button-container" th:if="${cri.auth == 1}">
		<button type="button"
			th:onClick="|location.href = '@{/minwonList(pageNum=${cri.pageNum}, type=${param.type}, keyword=${param.keyword})}'|"
			class="btn btn-outline-success m-2">목록</button>

		<!-- 접수 버튼 -->
		<form th:action="@{/updateMinwonState}" method="post">
			<input type="hidden" name="postNo" th:value="${minwon.postNo}" /> <input
				type="hidden" name="state" th:value="1" />
			<!-- 접수중은 숫자 1로 전송 -->
			<button type="submit" class="btn btn-outline-warning m-2">접수</button>
		</form>

		<!-- 완료 버튼 -->
		<form th:action="@{/updateMinwonState}" method="post">
			<input type="hidden" name="postNo" th:value="${minwon.postNo}" /> <input
				type="hidden" name="state" th:value="2" />
			<!-- 처리 완료는 숫자 2로 전송 -->
			<button type="submit" class="btn btn-outline-danger m-2">완료</button>
		</form>
	</div>

	<div>
		<section id="comments-section" th:style="'margin-top: 20px;'">

			<h4>comment</h4>
			<div id="comments-container">
				<!-- 댓글 목록이 여기에 동적으로 추가될 것입니다. -->
				<div class="ms-3" id="cmtContainer"></div>
			</div>
			<!-- 댓글 작성 폼 -->
			<form id="comment-form">
				<div class="form-group">
					<label for="comment">댓글 추가:</label>
					<textarea class="form-control" id="comment" rows="3"></textarea>
				</div>
				<button type="button" class="btn btn-primary"
					id="create-comment-btn">댓글 작성</button>
			</form>
		</section>

		<!-- 대댓글 작성 폼 -->
		<!-- 	<form id="comment-form">
			<div class="form-group">
				<label for="reply">대댓글 추가:</label>
				<textarea class="form-control" id="reply" rows="3"></textarea>
			</div>
			<button type="button" class="btn btn-primary" id="reply-comment-btn">댓글
				작성</button>
		</form> -->
	</div>

	<script>
	  var str = $("#textarea").html();
	  let postNo = $("#postNo").val();

	  str = str.replace(/(?:\r\n|\r|\n)/g, "<br/>");
	  $("#textarea").html(str);
	  loadComment();

	  // 댓글 목록 가져오기
	  function loadComment() {
	    $.ajax({
	      url: ctxPath + "/comments/" + postNo,
	      method: "GET",
	      success: function (response) {
	        let commentsContainer = $("#comments-container .ms-3");
	        commentsContainer.empty(); // 기존 댓글 삭제

	        if (response.comments.length) {
	          // 댓글 리스트가 있는 경우
	          response.comments.forEach(function (comment) {
	            let formattedDate = new Date(comment.regDate);
	            let dateString = `${formattedDate.getFullYear()}-${(
	              "0" +
	              (formattedDate.getMonth() + 1)
	            ).slice(-2)}-${("0" + formattedDate.getDate()).slice(-2)} ${(
	              "0" + formattedDate.getHours()
	            ).slice(-2)}:${("0" + formattedDate.getMinutes()).slice(-2)}`;

	            let deleteButton = "";
	            if (comment.writer === $("#loginId").val()) {
	              deleteButton = `<button class="delete-comment-btn" data-id="${comment.minwonCmtNo}">삭제</button>`;
	            }

	            let ply = comment.cmtRep == "1" ? "class='ply'" : "";
	            let onkey = comment.cmtRep == "0" ? "id='onkey'" : "";
	            if (comment.cmtRep == "0") {
	              let groupDiv = `
	                <div id='group${comment.cmtGroup}' class="group" data-group="${comment.cmtGroup}">
	                  <div ${ply} ${onkey}>
	                    <div class="comment-header">
	                      <div class="fw-bold">${comment.writer}</div> <!-- 작성자 -->
	                      ${deleteButton}
	                    </div>
	                    <div class="comment-content">${comment.content}</div> <!-- 댓글 내용 -->
	                    <div class="comment-footer">
	                      <div>${dateString}</div> <!-- 작성일 -->
	                      <input type="hidden" value=${comment.cmtGroup}>
	                    </div>
	                  </div>
	                </div>`;
	              commentsContainer.append(groupDiv);
	            } else {
	              let $groupDiv = $(`#group${comment.cmtGroup}`);
	              let commentElement = `
	                <div ${ply}>
	                  <div class="comment-header">
	                    <div class="fw-bold">${comment.writer}</div> <!-- 작성자 -->
	                    ${deleteButton}
	                  </div>
	                  <div class="comment-content">${comment.content}</div> <!-- 댓글 내용 -->
	                  <div class="comment-footer">
	                    <div>${dateString}</div> <!-- 작성일 -->
	                    <input type="hidden" value=${comment.cmtGroup}>
	                  </div>
	                </div>`;
	              $groupDiv.append(commentElement);
	            }
	          }); // 댓글 출력 반복문 끝

	          let $groupDivs = $(".group");
	          $groupDivs.each((idx, div) => {
	            let replyForm = `
	              <form id="cmtfrm${div.dataset.group}" style="display:none;">
	                <input type="hidden" name="cmtGroup" value="${div.dataset.group}">
	                <div class="form-group">
	                  <label for="reply${div.dataset.group}">대댓글 추가:</label>
	                  <textarea class="form-control" id="reply${div.dataset.group}" rows="3"></textarea>
	                </div>
	                <button type="button" class="btn btn-primary reply-comment-btn" data-group="${div.dataset.group}">댓글 작성</button>
	              </form>`;
	            $(div).append(replyForm);
	          });

	          // 대댓글 form 보이기 이벤트 (이미 열려 있는지 확인)
	          $("div#cmtContainer").on("click", "div.group > div#onkey", function (e) {
	            if (!$(e.target).hasClass("delete-comment-btn")) {
	              let replyForm = $(this).parent().children().last();
	              // 폼이 보이지 않을 때만 열림
	              if (!replyForm.is(":visible")) {
	                replyForm.toggle();
	              }
	            }
	          });

	          // 댓글 삭제 이벤트
	          $(document)
	            .off("click", ".delete-comment-btn") //중복 방지
	            .on("click", ".delete-comment-btn", function (e) {
	              e.stopPropagation(); // 이벤트 전파 방지

	              let parentCmtNo = $(this).data("id");
	              let isReply = $(this).closest(".ply").length > 0;
	              let message = isReply
	                ? "이 대댓글을 삭제하시겠습니까?"
	                : "이 댓글과 관련된 대댓글도 모두 삭제됩니다. 삭제하시겠습니까?";

	              if (confirm(message)) {
	                $.ajax({
	                  url: `${ctxPath}/comments/${parentCmtNo}`,
	                  method: "DELETE",
	                  success: function (response) {
	                    if (response === "success") {
	                      console.log("댓글 삭제 성공");
	                      loadComment(); // 댓글 목록 새로고침
	                    } else {
	                      alert("댓글 삭제에 실패했습니다.");
	                    }
	                  },
	                  error: function (xhr, status, error) {
	                    alert("댓글 삭제 실패. 오류: " + xhr.responseText);
	                  },
	                });
	              }
	            });

	          // 대댓글 등록 이벤트 (이벤트 위임)
	          $(document)
	            .off("click", ".reply-comment-btn")
	            .on("click", ".reply-comment-btn", function (e) {
	              e.preventDefault();
	              e.stopPropagation();

	              let group = $(this).data("group");
	              let content = $(`#reply${group}`).val();
	              let writer = $("#loginId").val();
	              let postNo = $("#postNo").val();

	              let data = {
	                content,
	                writer,
	                postNo,
	                cmtGroup: group,
	                cmtRep: "1",
	              }; // 대댓글은 cmtRep가 "1"
	              $.ajax({
	                url: ctxPath + "/replycomment/" + postNo,
	                method: "POST",
	                contentType: "application/json",
	                data: JSON.stringify(data),
	                success: function (response) {
	                  console.log(response, "대댓글 등록 성공");
	                  $(`#reply${group}`).val(""); // 대댓글 입력 필드 초기화
	                  loadComment();
	                },
	                error: function (err) {
	                  alert("대댓글 등록 실패");
	                },
	              });
	            });
	        } else {
	          console.log("댓글이 없습니다.");
	        }
	      },
	      error: function (err) {
	        console.log("댓글 불러오기 실패", err);
	      },
	    });
	  }

	  // 댓글 등록 버튼 클릭 이벤트
	  let cmtBtn = document.getElementById("create-comment-btn");
	  cmtBtn.addEventListener("click", function (e) {
	    let content = $("#comment").val();
	    let writer = $("#loginId").val();
	    let postNo = $("#postNo").val();

	    let data = { content, writer, postNo };
	    $.ajax({
	      url: ctxPath + "/comments/" + postNo,
	      method: "POST",
	      contentType: "application/json",
	      data: JSON.stringify(data),
	      success: function (response) {
	        console.log(response, "댓글 등록 성공");
	        $("#comment").val(""); // 댓글 입력 필드 초기화
	        loadComment();
	      },
	      error: function (err) {
	        alert("댓글 등록 실패");
	      },
	    });
	  });
    </script>
</body>
</html>
