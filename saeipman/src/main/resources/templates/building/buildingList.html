
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">
<head>
<meta charset="UTF-8">
<title>title</title>
<style>
.imgId {
	width: 200px;
	height: 200px;
}

.imgDiv {
	width: 1100px;
	display: inline;
}

#roomUpdate {
	display: none;
}

.deletedImg {
	display: none;
}

input {
	border-width: 0 0 1px;
}

.hoSel, .fl, .newRoom {
	width: 65px;
}

a.button {
	display: block;
	position: relative;
	float: left;
	width: 120px;
	padding: 0;
	margin: 10px 20px 10px 0;
	font-weight: 600;
	text-align: center;
	line-height: 40px;
	color: #FFF;
	border-radius: 5px;
	transition: all 0.2s;
	height: 40px;
}

.btnBlueGreen {
	background: #73bbfa;
}

.btnBlueGreen.btnPush {
	box-shadow: 0px 5px 0px 0px #5789b5;
}

.btnPush:hover {
	margin-top: 15px;
	margin-bottom: 5px;
}

.btnBlueGreen.btnPush:hover {
	box-shadow: 0px 0px 0px 0px #007144;
}
</style>
</head>
<body>
	<div layout:fragment="Main" class="row">
		<h4 class="mb-4">빌딩목록</h4>
		<!-- start 건물리스트 -->
		<div class="col-md-3" id="buildList">
			<th:block th:each="building, index:${buildings}">
				<div class="card border-secondary mb-3"
					th:id="${building.buildingId}" th:data-index="${index.count}">
					<div class="card-header"
						style="font-size: 18px; font-weight: bold;">[[${building.buildingName}]]</div>
					<div class="card-body text-secondary" style="font-size: 14px;">
						<p class="card-text">[[${building.doroAddr}]]
							[[${building.doroAddr}]]</p>
						<p class="card-text">[[${building.totalGagu}]]세대</p>
					</div>
				</div>
			</th:block>
			<button type="button"
				th:onclick="|location.href='@{/buildingInsert}'|"
				class="btn btn-outline-primary m-2">건물추가</button>
			<!-- 페이징 -->
			<th:block th:if="${page.total!=0}">
				<nav aria-label="Page navigation example">
					<ul class="pagination justify-content-center">
						<li class="page-item" th:if="${page.startPage > 1}"><a
							class="page-link"
							th:href="@{/buildingList?pageNum={page}(page = ${page.startPage -1})}"
							aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
						</a></li>

						<th:block
							th:with="start = ${page.startPage}, end = ${page.endPage}">
							<li class="page-item"
								th:with="start = ${page.startPage}, end = ${page.endPage}"
								th:each="pageButton : ${#numbers.sequence(start, end)}"><a
								class="page-link"
								th:href="@{/buildingList?pageNum={page} (page = ${pageButton})}"
								th:text=${pageButton}></a></li>
						</th:block>


						<li class="page-item" th:if="${page.next}"><a
							class="page-link"
							th:href="@{/buildingList?pageNum={page}(page = ${page.endPage +1})}"
							aria-label="Next"> <span aria-hidden="true">&raquo;</span>
						</a></li>
					</ul>
				</nav>
			</th:block>
		</div>
		<!-- end 페이징 -->

		<!-- End 건물리스트 -->
		<div class="col-md-7">
			<form name="updateForm" class="row g-3 infoDetail"
				enctype="multipart/form-data">
				<input name="groupId" type="hidden" class="groupid" />
				<!-- start 건물 정보 -->
				<h3 id="bnameTitle"></h3>
				<div style="text-align: center;">
					<button type="button" class="btn btn-outline-primary m-2 "
						id="updateBtn">수정완료</button>
					<button type="button"
						class="btn btn-outline-danger m-2 deleteBtn bid">삭제</button>
				</div>
				<!-- 	<div>
					<input name="buildingId" type="hidden" class="bid" />
				</div>
 -->
				<div>
					<div class="form-check form-switch" style="display: inline-block;">
						<label class="form-label"><span>연체 알림</span> </label><input
							role="switch" id="delayAlertYn" type="checkbox"
							class="form-check-input text-end" name="delayAlertYn" />
					</div>
					<div class="form-check form-switch" style="display: inline-block;">
						<label class="form-label"><span>민원 알림</span> </label><input
							role="switch" type="checkbox" class="form-check-input text-end"
							name="minwonAlertYn" id="minwonAlertYn" />
					</div>
				</div>

				<div id="imgFile"></div>

				<div class="col-md-4">
					<label for=" file" class="form-label">빌딩 이미지</label> <input
						type="file" id="file" multiple name="newFiles"
						class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="bname" class="form-label">빌딩 이름 </label> <input
						type="text" id="bname" name="buildingName" class="form-control">
				</div>
				<div class="form-group col-md-7">
					<label for="sample6_address" class="form-label"
						th:style="${'padding-right:20px'}">주소</label> <input type="button"
						onclick="sample6_execDaumPostcode()" value="주소 찾기"
						class="btn btn-outline-secondary m-2"> <input type="text"
						id="sample6_address" placeholder="주소" name="doroAddr"
						class="form-control addr">
				</div>
				<div class="form-group col-md-7">
					<label for="sample6_detailAddress" class="form-label">상세 주소</label>
					<input type="text" id="sample6_detailAddress" placeholder="상세주소"
						name="detailsAddr" class="form-control dAddr">
				</div>
				<div class="form-group col-md-5"></div>
				<div class="form-group col-md-5">
					<label for="floorArea" class="form-label">연면적 </label> <input
						type="text" id="floorArea" name="floorArea" class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="floorAreaRatio" class="form-label">용적률 산정용 연면적
					</label> <input type="text" id="floorAreaRatio" name="floorAreaRatio"
						class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="gunchookArea" class="form-label">건축면적 </label> <input
						type="text" id="gunchookArea" name="gunchookArea"
						class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="buildingHeigh" class="form-label">건물 높이 </label> <input
						type="text" id="buildingHeigh" name="buildingHeigh"
						class="form-control">
				</div>
				<div class="form-check form-switch">
					<label for="liftYn">승강기 여부 </label> <input type="checkbox"
						id="liftYn" name="liftYn" class="form-check-input text-end"
						role="switch">
				</div>
				<div class="form-group col-md-5">
					<label for="totalFloor" class="form-label">층 수 </label> <input
						type="text" id="totalFloor" name="totalFloor" class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="floorGaguCount" class="form-label">층 별 가구수 </label> <input
						type="text" id="floorGaguCount" name="floorGaguCount"
						class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="totalGagu" class="form-label">총 세대수 </label> <input
						type="text" id="totalGagu" name="totalGagu" class="form-control">
				</div>
				<div class="form-group col-md-5">
					<label for="parking" class="form-label">주차 가능 대수 </label> <input
						type="text" id="parking" name="parking" class="form-control">
				</div>
				<div class="form-group col-md-6">
					<label for="memo" class="form-label">비고 </label> <input type="text"
						id="memo" name="memo" class="form-control">
				</div>
				<!-- <button type="button" id="roomUpdateBtn">▼</button> -->
				<div class="row">
					<a title="Button push blue/green" id="roomUpdateBtn"
						class="button btnPush btnBlueGreen">방정보 수정</a>
				</div>
				<div id="roomUpdate">
					<div>
						<input type="hidden" name="buildingId" id="bid">
						<h5 id="staticBackdropLabel">방 수정</h5>
					</div>
					<div>
						<table class="table table-bordered">
							<thead>
								<tr>
									<th>층 수</th>
									<th colspan="4">호실</th>
								</tr>
							</thead>
							<tbody id="tb">

							</tbody>
						</table>
						<button type="button" id="floorInsert">+</button>
					</div>
				</div>

			</form>
		</div>
		<!-- End 건물 정보 -->

		<script>
		let floorList
		let updateRoomList = [];
		let delRoomList = [];
		let insertRoomList = [];
			$(document).ready(function() {
				let isRoomUpdateVisible = $('#roomUpdate').css('display') !== 'none';
				$('#roomUpdateBtn').on('click', function() {
				    $('#roomUpdate').toggle();
				});
				
				let firstBuilding = $('div[data-index="1"]').attr('id');
				if (firstBuilding) {
					getBuildingInfo(firstBuilding);
				}
				$('div').on('click', function(e) {
					$('#imgFile').html('');
					let buildingId = e.currentTarget.id;
					let a = 
					getBuildingInfo(buildingId);
				});
				function getBuildingInfo(buildingId) {
					//상세 정보
					$.ajax({
						url : ctxPath+ '/buildingDetails',
						type : 'GET',
						data : {
							id : buildingId,
						},
						dataType : 'json',

					}).done(function(data) {
						$('#bnameTitle').html(data.buildingName);
						$("#bname").val(data.buildingName);
						$(".addr").val(data.doroAddr);
						$(".dAddr").val(data.detailsAddr);
						$("#gunchookArea").val(data.gunchookArea);
						$('#delayAlertYn').val(data.delayAlertYn);
						$('#minwonAlertYn').val(data.minwonAlertYn);
						$("#liftYn").val(data.liftYn);
						$("#totalFloor").val(data.totalFloor);
						$("#floorGaguCount").val(data.floorGaguCount);
						$("#totalGagu").val(data.totalGagu);
						$("#parking").val(data.parking);
						$("#floorArea").val(data.floorArea);
						$("#buildingHeigh").val(data.buildingHeigh);
						$("#floorAreaRatio").val(data.floorAreaRatio);
						$('input[name="groupId"]').val(data.groupId);
						$('#bid').val(data.buildingId);
						$('#memo').val(data.memo);
						console.log(data.rooms,"방이다");
					
						if(data.rooms != null){
							$('#tb').html("");
							let floors = [];
							for(room of data.rooms){
								if(floors.indexOf(room.floor) == -1){
									floors.push(room.floor);
								}
							}
							for(let i = floors[0]; i <= floors[floors.length- 1]; i++){
								let tr = `<tr><td><input type='checkbox' id="checkbox${i}" class='selectRoom'><input type='text' name='floor'  value=${i} class='fl'></td>`;
								for(room of data.rooms){
									if(room.floor == i){
										tr += `<td><input type='checkbox' name = 'chk' ><input type='text'  class='hoSel' name = 'roomNo' id=${room.roomId} value=${room.roomNo}>
											<input type='hidden' name=${room.roomId}></td>`;
									} 
								}
									tr+=`<td><button type='button' class='addRoom'>추가</button>
									<button type='button' class='delRoom'>삭제</button></td>`;
								tr+= `</tr>`;
								$('#tb').append(tr);
							}
						}
						  // 방 정보가 갱신된 후에도 roomUpdate의 상태를 유지
				        if (isRoomUpdateVisible) {
				            $('#roomUpdate').show();
				        } else {
				            $('#roomUpdate').hide();
				        }
						
						//방번호 수정
						$('.hoSel').on('change',function(e){
							//호실 추가 리스트 
							/* $('.hoSel').each((idx,ele)=>{
								console.log(ele);
							}) */
							let roomNo = $(e.target).val();
							let roomId = $(e.target).attr('id');
						
							updateRoomList[roomId]=roomNo;
							console.log(updateRoomList ,'updateRoomList');
						
						})
						
						//이미지 파일
						if(data.fileName != null) {
							//$('#groupId').val(data.groupId);
							let images = data.fileName;
							
							for(img of images){
								let div = $('<div>').attr({'class':'imgDiv',  'data-fildid':img} );
								let imgName = $("<img>").attr({'src':ctxPath+'/images/'+'건물/'+img});
								let imgDel = $("<button>").attr('class','imageDel');
								imgName.attr("class",'imgId');
								imgDel.attr('type','button');
								imgDel.html('X');
								$("#imgFile").append(div);
								$(div).append(imgName);
								$(div).append(imgDel);
							} 
						} 
						//이미지 삭제
						$('.imageDel').on('click', imgaeDelFunc);
						
						checkFunc($("#liftYn"));
						$(".bid").val(data.buildingId);
						
					})
				}

			})
			
			//전체선택 및 선택해제
		 	$('#tb').delegate('.selectRoom','click',function(e){
				let parent = $(e.target).closest('tr');
				if($(e.target).is(":checked")){
					parent.find('input[name="chk"]').prop("checked",true);
									
				}else{
					parent.find('input[name="chk"]').prop("checked",false);
				
				}
			})
							
			$('#tb').delegate("input[name=chk]",'click',function(e) {
				let tr = $(e.target).closest('tr');
				let total = tr.find("input[name=chk]").length;
				let checked = tr.find("input[name=chk]:checked").length;
				
				if(total != checked) {
					tr.find(".selectRoom").prop("checked", false);
				}
				else {
					tr.find(".selectRoom").prop("checked", true); 
				}
			});//end 행선택
			//층 추가
			$('#floorInsert').on('click', function(){
				let newFloor;
			
				newFloor += `<tr>`;
				newFloor += `<td><input type="checkbox" class='selectRoom'><input type='text' name = 'floor' class="fl" placeholder='숫자입력'></td>`;
				newFloor +=`<td><button type='button' class='addRoom'>추가</button>
					<button type='button' class='delRoom'>삭제</button></td>`;
				newFloor+=`</tr>`;
				//$(newFloor).append(newButton);
				$('#tb').append(newFloor);
			});
			//호실 추가
			$('#tb').delegate('.addRoom','click',function(e){
				let addSel = $(e.target).closest('tr');
				//console.log(addSel);
				addSel.find('.addRoom').parent().before(`<td><input type="checkbox" name="chk"><input type="text" name='roomNo' class = "newRoom"></td>`);
				
			});
			
			//호실 번호 추가
			$('#tb').delegate('.newRoom','change',function(e){
				let roomNo = $(e.target).val();
				let floor = $(e.target).closest('tr').find('input[name=floor]').val();
				insertRoomList.push({floor,roomNo});
				console.log(insertRoomList,"방추가");
			})
			
			//호실 삭제
		 	$('#tb').delegate('.delRoom','click',function(e){
				let delSel = $(e.target).closest('tr');
				// 체크된 모든 항목에 대해 반복 
				delSel.find("input[name=chk]:checked").each(function() { 
					let roomId =  delSel.find("input[name=chk]:checked").next().attr('id'); // 각 체크된 항목의 ID 가져오기 
					delRoomList.push({
						roomId
					}); // 삭제 리스트에 추가
				});
				console.log(delRoomList);
				if(delSel.find('.selectRoom').is(':checked')){
					delSel.find('input[name=chk]').closest('tr').remove();

				}else{
					delSel.find("input[name=chk]:checked").parent().remove();
					
				}
			}); 
			
			
			//행 선택 checkbox
			$('.selectRoom').click(function(e){
			
				let parent = $(e.target).closest('tr')
				if($(e.target).is(":checked")){
					parent.find('input[name="chk"]').prop("checked",true);
									
				}else{
					parent.find('input[name="chk"]').prop("checked",false);
				
				}
			})
			$("input[name=chk]").click(function(e) {
				let tr = $(e.target).closest('tr');
				let total = tr.find("input[name=chk]").length;
				let checked = tr.find("input[name=chk]:checked").length;
				
				if(total != checked) {
					tr.find(".").prop("checked", false);
				}
				else {
					tr.find(".").prop("checked", true); 
				}
			});
			//end of $(document).ready
			
			let delList = [];
			
			function imgaeDelFunc(e){
				//console.log($(e.target).parent());
				$(e.target).parent().addClass("deletedImg"); //remove();
				let dImg = $(e.target).parent().data('fildid');
				delList.push({dImg});
				//console.log(delList);
	
			}
			
			
			function checkFunc(liftYn) {
				if (liftYn.val() === 'Y') {
					liftYn.prop('checked', true);
				} else {

					liftYn.prop('checked', false);
				}
			}//end of checkFunc
			//수정
			

			$('#updateBtn').on('click', submitUpdateForm);
			function submitUpdateForm(e) {
				let roomList = [];
				//let updateList = {};
			    let formData = new FormData(document.updateForm);
			    // 삭제된 파일 목록 추가
			    delList.forEach((fileName) => {
			        formData.append("deleteFileNames", fileName.dImg);
			    }); 
			  
			    //방 번호 수정
		     	for(roomId in updateRoomList){
		     		roomList.push({ roomId, roomNo: updateRoomList[roomId] });
			   	}  
			    formData.append("updateRoomList", JSON.stringify(roomList));
			 
		     	//방 삭제 리스트
				formData.append("deleteRoomList", JSON.stringify(delRoomList));
		     	
		     	//방 추가 리스트
				formData.append("insertRoomList", JSON.stringify(insertRoomList));

			    $.ajax({
			        url: ctxPath+'/buildingUpdate',
			        type: 'POST',
			        data: formData,
			        processData: false,
			        contentType: false,
			        success: function(response) {
			            alert("업데이트 성공");
			          
			            location.reload();
			            
			        },
			        error: function(error) {
			            console.error("업데이트 실패:", error);
			        }
			    });
			}

			
			//체크박스
			$('input:checkbox').change(function() {
				if (this.checked) {

					$(this).attr('value', 'Y');
				} else {
					$(this).attr('value', 'N');
				}
			})
			//삭제 버튼
			$('.deleteBtn').on('click',function(e){
				if(confirm('삭제 하시겠습니까?')==true){
					location.href= ctxPath + "/buildingDelete?id=" + e.target.value;
				}
				else{
					return;
				}
			})
		//방 수정 및 생성
		/* $('#roomUpdateBtn').on('click', function(){
			  if($('#roomUpdate').css('display') == 'none') {
				  $('#roomUpdate').show();
				  }else {
					  $('#roomUpdate').hide();
				  }
		});
		 */
		</script>
		<script
			src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
		<script>
		function sample6_execDaumPostcode() {
			new daum.Postcode({
				oncomplete : function(data) {
					// 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

					// 각 주소의 노출 규칙에 따라 주소를 조합한다.
					// 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
					var addr = ''; // 주소 변수
					var extraAddr = ''; // 참고항목 변수

					//사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
					if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
						addr = data.roadAddress;
					} else { // 사용자가 지번 주소를 선택했을 경우(J)
						addr = data.jibunAddress;
					}

					document.getElementById("sample6_address").value = addr;
					// 커서를 상세주소 필드로 이동한다.
					document.getElementById("sample6_detailAddress").focus();
				}
			}).open();
		}
	</script>
	</div>


</body>
</html>