<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">

<head>
<meta charset="UTF-8">

<style>
.table {
	margin-left: auto;
	margin-right: auto;
}

.table td, .table th {
	text-align: center;
	border-collapse: collapse;
	border: 0px solid black;
	color: black;
}

.settlingBtn {
	margin: auto;
	display: none;
	background: #6CBEC7;
	color: rgb(56, 53, 53);
}

#bName {
	float: left;
	color: #323f5d;
	font-size: 20px;
	font-weight: bold;
}
</style>

</head>

<body>
	<div layout:fragment="Main">
		<div>
			<br> <br>

			<!-- 건물명 -->
			<p id="bName"></p>

			<!-- Toast UI - Date Picker -->
			<div class="inputDiv"
				style="position: relative; z-index: 2; float: right;">
				<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
					<input type="text" id="datepicker-input-ko" aria-label="Year-Month">
					<span class="tui-ico-date"></span>
				</div>
				<div class="datepicker-cell" id="datepicker-month-ko"
					style="margin-top: -1px;"></div>
			</div>

			<br> <br>

			<!-- Toast UI - Grid -->
			<div id="grid" style="position: relative; z-index: 1;"></div>

			<hr style="color: black">
			<table class="table" style="width: 100%;">
				<tbody>
					<tr>
						<th style="width: 33.33%; color: #385d61;">TOTAL</th>
						<td id="totalGwanlibi" style="width: 33.33%;"></td>
						<td id="totalGwanlibiByGagu" style="width: 33.33%;"></td>
					</tr>
				</tbody>
			</table>
			<hr style="color: black">

			<button class="btn btn-light settlingBtn">관리비 정산</button>

			<br>
		</div>

		<script th:inline="javascript">
			// JavaScript에서 Thymeleaf 변수 사용하기 //
			/* 1. <script th:inline="javascript">
			   2. Thymeleaf 변수 사용 */
			   
			// 건물명 출력
			let building = [[${ buildingInfo }]];
			console.log(building);
			$('#bName').text(building.buildingName);
				
			let detailsList = [[${ detailsList }]];
		    


			// 해당 건물의 관리 비용 총합계 - number format (, 원)
			function total() {
				let totalGwanlibi = 0;
				for (i in detailsList) {
					totalGwanlibi += detailsList[i].gwanlibiItemMoney;
				} 
				//console.log(tatalGwanlibi);
				$('#totalGwanlibi').text(detailsList[0].totalMoney.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' 원');


				// 가구별 관리비 총합계
				/* let totalGwanlibiByGagu = 0;
				for (i in detailsList) {
					totalGwanlibiByGagu += Math.floor(detailsList[i].gwanlibiByGagu);
				} */
				//console.log(tatalGwanlibiByGabu);
				$('#totalGwanlibiByGagu').text(detailsList[0].gaguGwanlibi.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' 원');
			}


			


			// TOAST UI //
			// async - await
			$(document).ready(async () => {
				await gridLoad();
				await dateLoad();
				await total();
			});


			// Toast UI - Grid //
			// # reference : https://adjh54.tistory.com/95
			// # reference : https://park-duck.tistory.com/entry/javascript-1-Toast-UI-Grid-%EA%B8%B0%EC%B4%88API-%EC%82%AC%EC%9A%A9%EB%B2%95
			// 01. Grid 생성.
			// return void
			function gridLoad() {
				const Grid = tui.Grid;
				// 02. Grid theme 설정. (clean, stripe, default)
				Grid.applyTheme('stripe');

				// 03. Toast UI Grid 구성.
				const grid = new Grid({
					// ================================== 공통 옵션 적용 ================================== //
					el: document.getElementById('grid'), // 필수 : Container element
					data: detailsList,
					scrollX: false,
					scrollY: false,
					// ================================== 컬럼 옵션 적용 ================================== //
					columns: [
						// [Column-1] 관리비 항목 명
						{
							header: '관리비 항목 명',           // [필수] 컬럼 이름
							name: 'gwanlibiName',           // [필수] 컬럼 매핑 이름 값
							resizable: true,                // [선택] 컬럼의 리사이즈 여부 옵션
							align: 'center'
						},
						// [Column-2] 관리 비용
						{
							header: '관리 비용',
							name: 'strGwanlibiItemMoney',
							resizable: true,
							align: 'center'
						},
						// [Column-3] 가구별 관리비
						{
							header: '가구별 관리비',
							name: 'strGwanlibiByGagu',
							resizable: true,
							align: 'center'
						}
					]
				})
			}


			// Toast UI - Date Picker //
			// # reference : https://nhn.github.io/tui.date-picker/latest/tutorial-example05-picking-month
			// # reference : https://nhn.github.io/tui.date-picker/latest/DatePicker#event-change
			function dateLoad() {
				let calMonthKo = new tui.DatePicker('#datepicker-month-ko', {
					date: new Date(),
					language: 'ko',
					type: 'month',
					input: {
						element: '#datepicker-input-ko',
						format: 'yyyy년 M월'
						//format: 'yyyy-MM'
					},
				});

				// get date value
				calMonthKo.on('change', function() {
					//console.log(calMonthKo);
					let paymentMonth = dateToYM(calMonthKo.getDate());
					let buildingId = building.buildingId;
					//console.log(calMonthKo.getDate());
					//console.log(paymentMonth);
					console.log(buildingId);					

					$.ajax({
						url: `${ctxPath}/detailsBillList?buildingId=${buildingId}&paymentMonth=${paymentMonth}`,
						method: 'post'
					}).done(function (result) {
						console.log(result)
						$('#grid').html('');
						detailsList = result.detailsList;
						gridLoad();
						total();
						console.log('성공');
					}).fail(function (err) {
						console.log(err);
					})

					// 등록/수정 버튼 출력 여부 설정 : 전월에만 보이기
					let now = new Date();
					let previousYearMonth = now.getFullYear() + '-' + (now.getMonth()).toString().padStart(2, 0);
					console.log('===============');
					console.log(paymentMonth);
					console.log(previousYearMonth);
					console.log('===============');
					if (paymentMonth == previousYearMonth) {
						$('.settlingBtn').css('display', 'block');
					} else {
						$('.settlingBtn').css('display', 'none');
					}
					
					
				});

			}
			
			// 정산 버튼
			$('.settlingBtn').click(function() {
				$.ajax({
					url: `${ctxPath}/gwanlibiCalculationForm?buildingId=${building.buildingId}`,
					method: 'post',
					contentType: 'application/json',
					data: JSON.stringify(detailsList)
				}).done(function(result) {
					if(result.gwanlibiItmeListSize <= 0) {
						alert('관리비 항목이 미등록되어있습니다. 관리비 항목을 등록해주세요.');
						location.href = ctxPath + '/itemList?buildingId=' + building.buildingId;
					} else {
						location.href = ctxPath + result.url;						
					}
				}).fail(function(err) {
					console.log(err);
				})
			})
			


		</script>
	</div>
</body>

</html>