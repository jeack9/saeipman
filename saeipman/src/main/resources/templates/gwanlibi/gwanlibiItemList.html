<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">

<head>
<meta charset="UTF-8">
<style>
#bName {
	float: left;
	color: #323f5d;
	font-size: 20px;
	font-weight: bold;
}

.btnDiv, .btnDiv2 {
	text-align: center;
}

.btnDiv2 {
	margin-top: 10px
}

#appendBtn, #deleteBtn {
	display: inline-block;
	background: #6CBEC7;
	color: rgb(56, 53, 53);
}

#validateMsg {
	background-color: rgba(0, 0, 0, 0.4);
	width: 40%;
	height: 30%;
	z-index: 10;
	/* 
	position: fixed;
	top: 0;
	left: 0; */ 
    /* width: "100%",;
	backgroundColor: " rgba(0, 0, 0, 0.4)",
    width: "100%",
    height: "100vh",
    zIndex: "10",
    position: "fixed",
    top: "0",
    left: "0", */
}
</style>

</head>

<body>
	<div layout:fragment="Main">

		<div>
			<br> <br>

			<!-- ê±´ë¬¼ëª… -->
			<p id="bName"></p>
			
			<!-- ë‚ ì§œ ì„ íƒ -->
			<div style="float: right;">
				<p style="display: inline;">ê´€ë¦¬ë¹„ ë‚©ë¶€ì¼ì ì„ íƒ : ë‚©ë¶€ì¼ì´ ê³ ì •ì´ë©´ í•œ ë²ˆë§Œ ì„¤ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</p>
				<input type="date" class="form-control" id="selectedDate" style="display: inline-block;  width: 50%">
			</div>

			<br> <br>

			<!-- Toast UI - Grid -->
			<div id="grid" style="position: relative; z-index: 1;"></div>

			<br>

			<div class="btnDiv">
				<button class="btn btn-light" id="appendBtn">ì¶”ê°€</button>
				<button class="btn btn-light" id="deleteBtn">ì‚­ì œ</button>
			</div>
			
			<br>
			
			<div class="btnDiv2">
				<button class="btn btn-primary saveBtn">ì €ì¥</button>
				<button class="btn btn-primary" th:onclick="|location.href='@{/gwanlibiDetailsBillList(buildingId=${buildingInfo.buildingId})}'|">ì •ì‚°</button>
			</div>
			<br>

		</div>

		<script th:inline="javascript">

			// JavaScriptì—ì„œ Thymeleaf ë³€ìˆ˜ ì‚¬ìš©í•˜ê¸° //
			/* 1. <script th:inline="javascript">
			   2. Thymeleaf ë³€ìˆ˜ ì‚¬ìš© */
			let gwanlibiItemlist = /*[[${ gwanlibiItemlist }]]*/'ê¸°ë³¸ê°’';
			console.log(gwanlibiItemlist);
			let buildingInfo = /*[[${ buildingInfo }]]*/'ê¸°ë³¸ê°’';
			let buildingId = buildingInfo.buildingId;
			console.log(buildingInfo);
			
			// ê±´ë¬¼ ì´ë¦„ ì¶œë ¥.
			$('#bName').text(buildingInfo.buildingName);

			// TOAST UI //
			// async - await
			let grid;
			$(document).ready(() => {
				grid = gridLoad();
			});


			// Toast UI - Grid //
			// # reference : https://adjh54.tistory.com/95
			// # reference : https://park-duck.tistory.com/entry/javascript-1-Toast-UI-Grid-%EA%B8%B0%EC%B4%88API-%EC%82%AC%EC%9A%A9%EB%B2%95
			// 01. Grid ìƒì„±.
			// return void
			const gridLoad = () => {
				const Grid = tui.Grid;
				// 02. Grid theme ì„¤ì •. (clean, stripe, default)
				Grid.applyTheme('stripe');

				// 03. Toast UI Grid êµ¬ì„±.
				const grid = new Grid({
					// ================================== ê³µí†µ ì˜µì…˜ ì ìš© ================================== //
					el: document.getElementById('grid'), // í•„ìˆ˜ : Container element
					data: gwanlibiItemlist,
					scrollX: false,
					scrollY: false,
					rowHeaders: ['checkbox'],
					// ================================== ì»¬ëŸ¼ ì˜µì…˜ ì ìš© ================================== //
					columns: [
						{
			                header: 'ë²ˆí˜¸',
			                name: 'gwanlibiItemNo',
			                hidden: true
			            },
			            {
			                header: 'ë²„ì „',
			                name: 'version',
			                hidden: true
			            },
			            {
			                header: 'ê±´ë¬¼ ë²ˆí˜¸',
			                name: 'buildingId',
			                hidden: true
			            },
						// [Column-1] ê´€ë¦¬ë¹„ í•­ëª©
						{
							header: 'ê´€ë¦¬ë¹„ í•­ëª©',
							name: 'gwanlibiName',
							validation: {
						        dataType: 'string',
						        required: true
						      },
							resizable: true,
							align: 'center',
							sortable: true,
							editor: 'text'
						},
						// [Column-2] ê´€ë¦¬ë¹„ ë³€ë™ ì—¬ë¶€
						{
							header: 'ê´€ë¦¬ë¹„ ë³€ë™ ì—¬ë¶€',
							name: 'variableYn',
							validation: {
						        dataType: 'string',
						        required: true
						      },
							resizable: true,
							align: 'center',
							editor: {
								type: 'select',
								options: {
									listItems: [
										{ text: 'ë³€ë™', value: 'ë³€ë™' },
										{ text: 'ê³ ì •', value: 'ê³ ì •' }
									]
								}
							}
						},
						// [Column-3] ê³ ì • ê´€ë¦¬ë¹„
						{
							header: 'ê³ ì • ê´€ë¦¬ë¹„',
							name: 'fixedPrice',
							resizable: true,
							align: 'center',
							editor: 'text'
						}
					]
				})
				//grid.validate();
				
				grid.getData().forEach(ele => {
					console.log(ele.rowKey);
					if(ele.variableYn == 'ë³€ë™') {
						grid.disableCell(ele.rowKey, 'fixedPrice');
					} else {
						grid.enableCell(ele.rowKey, 'fixedPrice');
					}
				})
				
				// ìˆ˜ì •ëœ ë°ì´í„°ê°€ ê³ ì •ì´ë©´ í•´ë‹¹ ì…€ì— ê°’ ì…ë ¥ ë§‰ê¸°.
				grid.on('click', function(event) {
					//console.log(grid.getModifiedRows());
					if(grid.getModifiedRows().createdRows.length >= 1  || grid.getModifiedRows().updatedRows.length >= 1) {
						grid.getData().forEach(ele => {
							if(ele.variableYn == 'ë³€ë™') {
								grid.disableCell(ele.rowKey, 'fixedPrice');
							} else {								
								grid.enableCell(ele.rowKey, 'fixedPrice');
							}
						})
					}
				})
				return grid;
			}
			
			const appendBtn = document.getElementById('appendBtn');
			const deleteBtn = document.getElementById('deleteBtn');
			
		    appendBtn.addEventListener('click', function() {
		        grid.appendRow({ variableYn: 'ë³€ë™', fixedPrice: 0 });
		    });
		    
		    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ, ì²´í¬ëœ í•­ëª©ì´ ì—†ì„ ê²½ìš°.
		    deleteBtn.addEventListener('click', function() {
		    	if(grid.getCheckedRows().length <= 0){
		    		alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
		    	} else {
			    	grid.removeCheckedRows();		    		
		    	}
			});
		    
		    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, ìœ íš¨ì„± ê²€ì‚¬ í›„ ì•„ì‘ìŠ¤ ì²˜ë¦¬.
			$('.saveBtn').on('click', function() {
		    	//event.preventDefault();
				console.log($('#selectedDate').val());
		    	let selectedDate = $('#selectedDate').val();
		    	// ì˜ˆì™¸ì²˜ë¦¬ 1
		    	if(!buildingId) return;
		    	
		    	// ì˜ˆì™¸ ì²˜ë¦¬ - ìœ íš¨ì„± ê²€ì‚¬ 2
		    	if(grid.validate().length >= 1) {
		    		
					Swal.fire({
		    			  icon: "error",
		    			  title: "Oops...",
		    			  text: "ì…ë ¥í•œ ë‚´ìš©ì„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”."
		    			});
					
		    		return;
		    	}
		    	
		    	// ì˜ˆì™¸ ì²˜ë¦¬ 3
		    	if(selectedDate == '') {
		    		
		    		Swal.fire({
		    			  icon: "error",
		    			  title: "Oops...",
		    			  text: "ë‚©ë¶€ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
		    			});
		    		
		    		return;						
				}
		    	
 				$.ajax({
					url: `${ctxPath}/insertItems?buildingId=${buildingId}&selectedDate=${selectedDate}`,
					method: 'post',
					contentType: 'application/json',
					data: JSON.stringify(grid.getData())

				}).done(function(result) {					
					
					console.log('success');
					console.log(result);
					Swal.fire({
		    			  icon: "success",
		    			  title: "ë“±ë¡ ì™„ë£Œ ğŸ˜Š",
		    			  text: `${result}ê±´ì˜ ê´€ë¦¬ë¹„ í•­ëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. `
	    			});
					
				}).fail(function(err){
					console.log(err);
					Swal.fire({
		    			  icon: "error",
		    			  title: "ë“±ë¡ ì‹¤íŒ¨ ğŸ˜¢",
		    			  text: "ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
	    			});
				});
		    		
		    	
			});
		    
		    /* $('.saveBtn').on('click', function() {
		    	//event.preventDefault()		    	
		    	if(!buildingId) return;
		    	let data = grid.getData();
		    	data.forEach(ele => {
		    		if(ele.gwanlibiName == '' || ele.gwanlibiName == 'ì¶”ê°€í•  ê´€ë¦¬ë¹„ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.') {
		    			alert('ê´€ë¦¬ë¹„ í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.');
		    			//event.preventDefault();
		    			return;
		    		} else {
						$.ajax({
							url: `${ctxPath}/insertItems?buildingId=${buildingId}`,
							method: 'post',
							contentType: 'application/json',
							data: JSON.stringify(grid.getData())
						}).done(function(result) {
							console.log('success');
							console.log(result);
							alert(result + 'ê±´ì´ ì •ìƒì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤');
						}).fail(function(err){					
							console.log('fail');
							alert('ê´€ë¦¬ë¹„ í•­ëª© ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
							alert('ìˆ˜ì • í•­ëª©ì„ í•œ ë²ˆ ë” í™•ì¸í•´ì£¼ì„¸ìš”.');
							console.log(err);
						});
		    		}
		    	})
			}); */

		</script>
	</div>
</body>

</html>