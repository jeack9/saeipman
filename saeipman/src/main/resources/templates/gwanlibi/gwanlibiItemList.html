<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{common/layouts/default_layout}">

<head>
	<meta charset="UTF-8">
	<style>
		#bName {
			display: inline-block;
			color: rgb(35, 35, 35);
			font-size: 19px;
			padding-left: 5px;
			margin-bottom: 8px;
		}

		.aa {
			position: relative;
		}

		.cc {
			display: inline-block;
		}

		.tip {
			float: right;
			position: absolute;
			top: 8px;
			left: 55px;

			font-size: 14px;
			line-height: 26px;
			text-align: center;

			background-color: #b3dfe6;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			cursor: default;
		}

		.tip:before {
			content: '?';
			font-weight: bold;
			color: #fff;
		}

		.tip:hover p {
			visibility: visible;
			opacity: 1;
		}

		.tip p {
			opacity: 0;
			visibility: hidden;

			color: #fff;
			font-size: 13px;
			line-height: 1.4;
			text-align: left;

			background-color: #0064b7;
			width: 400px;
			padding: 20px;
			border-radius: 3px;
			box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2), -1px -1px 3px rgba(0, 0, 0, 0.2);

			position: absolute;
			right: -370px;

			transition: visibility 0s, opacity 0.5s linear;
		}

		.tip p:before {
			position: absolute;
			content: '';
			width: 0;
			height: 0;
			border: 6px solid transparent;
			border-bottom-color: #0064b7;
			left: 10px;
			top: -12px;
		}

		.btnDiv {
			margin-top: 20px;
			text-align: center;
		}

		.btnDiv2 {
			margin-top: 10px
		}

		#appendBtn,
		#deleteBtn,
		.saveBtn {
			display: inline-block;
		}

		#appendBtn,
		#deleteBtn {
			border-color: black;
			color: black;
			margin-left: 10px;
		}

		#appendBtn:hover,
		#deleteBtn:hover {
			border-color: black;
			background: rgba(124, 178, 239, 0.4);
			color: black;
		}

		.saveBtn {
			background: rgba(107, 166, 233, 0.8);
			color: black;
			font-weight: lighter;
			border: solid black 1px;
		}

		.saveBtn:hover {
			background: rgb(225, 225, 225);
			color: rgb(54, 54, 54);
			font-weight: lighter;
		}

		.aDiv {
			margin-top: 20px;
			text-align: center;
		}

		.goBtn {
			text-decoration: none;
			color: black;
		}
	</style>
</head>

<body>
	<div layout:fragment="Main" class="container">
		<h4 class="mt-5 mb-4">ê±´ë¬¼ ê´€ë¦¬ë¹„ í•­ëª© ì„¤ì •</h4>
		<!-- 		<div class="aa">
			<div class="tip cc">
				<p class="cc">ê´€ë¦¬ë¹„ í•­ëª©ì„ ë“±ë¡ ë° ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>í•­ëª© ì„¤ì •ì´ ìµœì´ˆë¼ë©´ ê¸°ë³¸ì ì¸ ê´€ë¦¬ë¹„ í•­ëª©ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
			</div>
		</div> -->

		<div>
			<!-- ê±´ë¬¼ëª… -->
			<!-- <p style="float: left;"># ê´€ë¦¬ë¹„ í•­ëª© ì„¤ì •</p> -->
			<div style="text-align: left;">
				<i class="fa-solid fa-house" style="color: rgba(53, 133, 225, 0.8); display: inline-block;"></i>
				<p id="bName"></p>
			</div>


			<!-- Toast UI - Grid -->
			<div id="grid" style="position: relative; z-index: 1;"></div>


			<div class="btnDiv">
				<button class="btn btn-outline-primary m-1 " id="appendBtn">ì¶”ê°€</button>
				<button class="btn btn-outline-primary m-1 " id="deleteBtn">ì‚­ì œ</button>

				<button class="btn m-1 saveBtn">ì €ì¥</button>
			</div>

			<div class="aDiv">
				<a class="goBtn"
					th:onclick="|location.href='@{/gwanlibiDetailsBillList(buildingId=${buildingInfo.buildingId})}'|">ê´€ë¦¬ë¹„
					ìƒì„¸ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™</a>
			</div>

			<br>

		</div>

		<script th:inline="javascript">

			// JavaScriptì—ì„œ Thymeleaf ë³€ìˆ˜ ì‚¬ìš©í•˜ê¸° //
			/* 1. <script th:inline="javascript">
			   2. Thymeleaf ë³€ìˆ˜ ì‚¬ìš© */
			let gwanlibiItemlist = /*[[${ gwanlibiItemlist }]]*/'ê¸°ë³¸ê°’';
			let buildingInfo = /*[[${ buildingInfo }]]*/'ê¸°ë³¸ê°’';
			let buildingId = buildingInfo.buildingId;

			// ê±´ë¬¼ ì´ë¦„ ì¶œë ¥.
			$('#bName').text(buildingInfo.buildingName);

			// TOAST UI //
			// async - await
			let grid;
			$(document).ready(() => {
				grid = gridLoad();
			});


			// Toast UI - Grid //
			// # reference : https://adjh54.tistory.com/95
			// # reference : https://park-duck.tistory.com/entry/javascript-1-Toast-UI-Grid-%EA%B8%B0%EC%B4%88API-%EC%82%AC%EC%9A%A9%EB%B2%95
			// 01. Grid ìƒì„±.
			// return void
			const gridLoad = () => {
				const Grid = tui.Grid;
				// 02. Grid theme ì„¤ì •. (clean, stripe, default)
				Grid.applyTheme('stripe');

				// 03. Toast UI Grid êµ¬ì„±.
				const grid = new Grid({
					// ================================== ê³µí†µ ì˜µì…˜ ì ìš© ================================== //
					el: document.getElementById('grid'), // í•„ìˆ˜ : Container element
					data: gwanlibiItemlist,
					scrollX: false,
					scrollY: false,
					rowHeaders: ['checkbox'],
					// ================================== ì»¬ëŸ¼ ì˜µì…˜ ì ìš© ================================== //
					columns: [
						// hidden columns
						{
							header: 'ë²ˆí˜¸',
							name: 'gwanlibiItemNo',
							hidden: true
						},
						{
							header: 'ë²„ì „',
							name: 'version',
							hidden: true
						},
						{
							header: 'ê±´ë¬¼ ë²ˆí˜¸',
							name: 'buildingId',
							hidden: true
						},
						// [Column-1] ê´€ë¦¬ë¹„ í•­ëª©
						{
							header: 'ê´€ë¦¬ë¹„ í•­ëª©',
							name: 'gwanlibiName',
							validation: {
								dataType: 'string',
								required: true
							},
							resizable: true,
							align: 'center',
							sortable: true,
							editor: 'text'
						},
						// [Column-2] ê´€ë¦¬ë¹„ ë³€ë™ ì—¬ë¶€
						{
							header: 'ê´€ë¦¬ë¹„ ë³€ë™ ì—¬ë¶€ â–¼',
							name: 'variableYn',
							validation: {
								dataType: 'string',
								required: true
							},
							resizable: true,
							align: 'center',
							editor: {
								type: 'select',
								options: {
									listItems: [
										{ text: 'ë³€ë™', value: 'ë³€ë™' },
										{ text: 'ê³ ì •', value: 'ê³ ì •' }
									]
								}
							}
						},
						// [Column-3] ê³ ì • ê´€ë¦¬ë¹„
						{
							header: 'ê³ ì • ê´€ë¦¬ë¹„ (WON)',
							name: 'fixedPrice',
							resizable: true,
							align: 'center',
							editor: 'text',
							validation: {
								dataType: 'number',
								regExp: /^[0-9]*$/,
								required: true,
								min: 0
							}
						}
					]
				})

				// ê´€ë¦¬ë¹„ ê¸ˆì•¡ ìƒíƒœ ë³€ë™ -> cell disable
				grid.getData().forEach(ele => {
					console.log(ele.rowKey);
					if (ele.variableYn == 'ë³€ë™') {
						grid.disableCell(ele.rowKey, 'fixedPrice');
					} else {
						grid.enableCell(ele.rowKey, 'fixedPrice');
					}
				})

				// ìˆ˜ì •ëœ ê´€ë¦¬ë¹„ ê¸ˆì•¡ ìƒíƒœ ë³€ë™ -> cell disable
				grid.on('click', function (event) {
					//console.log(grid.getModifiedRows());
					if (grid.getModifiedRows().createdRows.length >= 1 || grid.getModifiedRows().updatedRows.length >= 1) {
						grid.getData().forEach(ele => {
							if (ele.variableYn == 'ë³€ë™') {
								grid.disableCell(ele.rowKey, 'fixedPrice');
							} else {
								grid.enableCell(ele.rowKey, 'fixedPrice');
							}
						})
					}
				})

				return grid;
			}

			const appendBtn = document.getElementById('appendBtn');
			const deleteBtn = document.getElementById('deleteBtn');

			appendBtn.addEventListener('click', function () {
				grid.appendRow({ variableYn: 'ë³€ë™', fixedPrice: 0 }); // ì¶”ê°€ -> default value setting
			});

			// ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ, ì²´í¬ëœ í•­ëª©ì´ ì—†ì„ ê²½ìš°.
			deleteBtn.addEventListener('click', function () {
				if (grid.getCheckedRows().length <= 0) {
					Swal.fire({
						icon: "error",
						text: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”."
					});
					return;
				} else {
					grid.removeCheckedRows();
				}
			});

			// ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, ìœ íš¨ì„± ê²€ì‚¬ í›„ ì•„ì‘ìŠ¤ ì²˜ë¦¬.
			$('.saveBtn').on('click', function () {
				//event.preventDefault();

				// ìœ íš¨ì„± ê²€ì‚¬ 1
				if (!buildingId) return;

				// grid.getModifiedRows().updatedRows.forEach(ele => {
				// 	if(!isNaN(ele.fixedPrice) || ele.fixedPrice == '' || ele.fixedPrice < 0) {
				// 		Swal.fire({
				// 		icon: "error",
				// 		text: "ê¸ˆì•¡ì„ ì •í™•í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”."
				// 	});
				// 	return;
				// 	}
				// })

				// ìœ íš¨ì„± ê²€ì‚¬ 2
				if (grid.validate().length >= 1) {
					Swal.fire({
						icon: "error",
						text: "ì…ë ¥í•œ ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”."
					});
					return;
				}


				$.ajax({
					url: `${ctxPath}/insertItems?buildingId=${buildingId}`,
					method: 'post',
					contentType: 'application/json',
					data: JSON.stringify(grid.getData())

				}).done(function (result) {

					console.log('success');
					console.log(result);
					Swal.fire({
						icon: "success",
						title: "ë“±ë¡ ì™„ë£Œ ğŸ˜Š",
						text: `${result}ê±´ì˜ ê´€ë¦¬ë¹„ í•­ëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. `
					});

				}).fail(function (err) {
					console.log(err);
					Swal.fire({
						icon: "error",
						title: "ë“±ë¡ ì‹¤íŒ¨ ğŸ˜¢",
						text: "ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
					});
				});
			});

		</script>
	</div>
</body>

</html>